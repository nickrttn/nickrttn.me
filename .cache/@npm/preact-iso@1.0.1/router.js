import{h as r,cloneElement as t,createContext as e}from"/@npm/preact";import{useReducer as n,useMemo as o,useEffect as c,useContext as i,useRef as a,useLayoutEffect as u}from"/@npm/preact/hooks";const UPDATE=(r,t,e)=>{if(t&&"click"===t.type){const n=t.target.closest("a[href]");if(!n||n.origin!=location.origin)return r;t.preventDefault(),e=!0,t=n.href.replace(location.origin,"")}else"string"!=typeof t&&(t=location.pathname+location.search);return!0===e?history.pushState(null,"",t):!1===e&&history.replaceState(null,"",t),t},exec=(r,t,e)=>{r=r.trim("/").split("/"),t=(t||"").trim("/").split("/");for(let n,o=0;o<Math.max(r.length,t.length);o++){let[,c,i,a]=(t[o]||"").match(/^(:?)(.*?)([+*?]?)$/);if(n=r[o],c||i!=n){if(!c||!n&&"?"!=a&&"*"!=a)return;if(e[i]=n&&decodeURIComponent(n),!(a>="?")){e[i]=r.slice(o).map(decodeURIComponent).join("/");break}}}return e};function LocationProvider(t){const[e,i]=n(UPDATE,location.pathname+location.search),a=o(()=>{const r=new URL(e,location.origin),t=r.pathname.replace(/(.)\/$/g,"$1");return{url:e,path:t,query:Object.fromEntries(r.searchParams),route:i}},[e]);return c(()=>(addEventListener("click",i),addEventListener("popstate",i),()=>{removeEventListener("click",i),removeEventListener("popstate",i)}),[]),r(LocationProvider.ctx.Provider,{value:a},t.children)}function Router(e){const[,c]=n(r=>r+1,0),i=useLocation(),{url:p,path:s,query:d}=i,h=a(i),m=a(),v=a(),f=a(),L=a();let g=!1;return p!==h.current.url&&(g=!0,L.current=null,m.current=h.current,f.current=v.current,f.current.props.pending=L,h.current=i),v.current=o(()=>{let n,o,c;return[].concat(e.children||[]).some(r=>{if(exec(s,r.props.path,c={path:s,query:d}))return n=t(r,c);r.props.default&&(o=t(r,c))}),r(Committer,{},r(l.Provider,{value:c},n||o))},[p]),this.componentDidCatch=r=>{r&&r.then&&(L.current=r)},u(()=>{let r=L.current;const commit=()=>{h.current.url===p&&L.current===r&&(m.current=f.current=L.current=null,e.onLoadEnd&&e.onLoadEnd(p),c(0))};r?(e.onLoadStart&&e.onLoadStart(p),r.then(commit)):commit()},[p]),g&&this.__v&&this.__v.__k&&this.__v.__k.reverse(),[v.current,f.current]}function Committer({pending:r,children:t}){return r&&!r.current?null:t}Router.Provider=LocationProvider,LocationProvider.ctx=e({});const l=e({}),useLocation=()=>i(LocationProvider.ctx),useRoute=()=>i(l);export{LocationProvider,Router,exec,useLocation,useRoute};